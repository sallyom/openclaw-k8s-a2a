# Deployment: NPS Agent with A2A bridge and AuthBridge sidecars
# Combines the upstream NPS Agent (built from GitHub) with the A2A protocol
# bridge and SPIFFE/Keycloak identity layer for cross-namespace communication
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nps-agent
  namespace: ${NPS_AGENT_NAMESPACE}
  labels:
    app: nps-agent
    kagenti.io/type: agent
    kagenti.io/protocol: a2a
    kagenti.io/framework: "MLflow"
    kagenti.io/workload-type: deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nps-agent
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: nps-agent
      annotations:
        kagenti.io/description: "National Park Service AI Agent with A2A identity"
    spec:
      serviceAccountName: nps-agent-oauth-proxy
      initContainers:
      # AuthBridge: iptables redirect for transparent Envoy interception
      - name: proxy-init
        image: ghcr.io/kagenti/kagenti-extensions/proxy-init@sha256:401885edb969a53ef21f4ced1ba02e5141469fe0b32bb461ab4daec9d6a47cfe
        imagePullPolicy: IfNotPresent
        env:
        - name: PROXY_PORT
          value: "15123"
        - name: INBOUND_PROXY_PORT
          value: "15124"
        - name: PROXY_UID
          value: "1337"
        - name: OUTBOUND_PORTS_EXCLUDE
          value: "443,4317,4318,8090"
        - name: INBOUND_PORTS_EXCLUDE
          value: "8080,8090"
        resources:
          requests:
            cpu: 10m
            memory: 10Mi
          limits:
            cpu: 10m
            memory: 10Mi
        securityContext:
          runAsUser: 0
          runAsNonRoot: false
          capabilities:
            add:
            - NET_ADMIN
            - NET_RAW
          seLinuxOptions:
            type: spc_t
      containers:
      # NPS Agent — the upstream Python agent from https://github.com/Nehanth/nps_agent
      - name: nps-agent
        image: image-registry.openshift-image-registry.svc:5000/${NPS_AGENT_NAMESPACE}/nps-agent:latest
        ports:
        - containerPort: 8090
          protocol: TCP
        envFrom:
        - secretRef:
            name: nps-agent-secrets
        env:
        - name: PORT
          value: "8090"
        - name: HOST
          value: "0.0.0.0"
        - name: MLFLOW_TRACKING_URI
          valueFrom:
            secretKeyRef:
              name: nps-agent-secrets
              key: MLFLOW_TRACKING_URI
              optional: true
        - name: MLFLOW_TRACKING_AUTH
          value: "kubernetes"
        - name: MLFLOW_EXPERIMENT_NAME
          value: "NPSAgent"
        resources:
          requests:
            cpu: 100m
            memory: 512Mi
          limits:
            cpu: "1"
            memory: 2Gi
        volumeMounts:
        - name: npsagent-patch
          mountPath: /opt/app-root/src/npsagent.py
          subPath: npsagent.py
        readinessProbe:
          httpGet:
            path: /ping
            port: 8090
          initialDelaySeconds: 30
          periodSeconds: 10
        livenessProbe:
          httpGet:
            path: /ping
            port: 8090
          initialDelaySeconds: 60
          periodSeconds: 30
      # A2A bridge: translates A2A JSON-RPC to NPS Agent's /invocations API
      - name: a2a-bridge
        image: registry.access.redhat.com/ubi9/nodejs-20-minimal:latest
        command: ["node", "/bridge/a2a-bridge.js"]
        ports:
        - name: a2a
          containerPort: 8080
          protocol: TCP
        env:
        - name: BACKEND_PORT
          value: "8090"
        - name: AGENT_NAME
          value: "NPS Agent"
        - name: AGENT_DESCRIPTION
          value: "National Park Service Information Assistant"
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        volumeMounts:
        - name: a2a-bridge-script
          mountPath: /bridge
          readOnly: true
        resources:
          requests:
            memory: 32Mi
            cpu: 25m
          limits:
            memory: 64Mi
            cpu: 100m
        livenessProbe:
          httpGet:
            path: /health
            port: a2a
          initialDelaySeconds: 5
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /health
            port: a2a
          initialDelaySeconds: 3
          periodSeconds: 10
        securityContext:
          allowPrivilegeEscalation: false
          runAsNonRoot: true
          readOnlyRootFilesystem: true
          capabilities:
            drop:
            - ALL
      # AuthBridge: SPIFFE Helper — fetches SVIDs from SPIRE agent
      - name: spiffe-helper
        image: ghcr.io/spiffe/spiffe-helper:nightly
        imagePullPolicy: IfNotPresent
        command:
        - /spiffe-helper
        - -config=/etc/spiffe-helper/helper.conf
        - run
        volumeMounts:
        - name: authbridge-spiffe-helper-config
          mountPath: /etc/spiffe-helper
        - name: spire-agent-socket
          mountPath: /run/spire/agent-sockets
          readOnly: true
        - name: svid-output
          mountPath: /opt
        resources:
          requests:
            cpu: 25m
            memory: 32Mi
          limits:
            cpu: 100m
            memory: 64Mi
        securityContext:
          seLinuxOptions:
            type: spc_t
      # AuthBridge: Client Registration — registers with Keycloak using SPIFFE ID
      - name: client-registration
        image: ghcr.io/kagenti/kagenti-extensions/client-registration:latest
        imagePullPolicy: IfNotPresent
        command:
        - /bin/sh
        - -c
        - |
          echo "Waiting for SPIFFE credentials..."
          while [ ! -f /opt/jwt_svid.token ]; do
            echo "Waiting for SVID..."
            sleep 2
          done
          echo "SPIFFE credentials ready!"

          # Extract and save the client ID (SPIFFE ID) from the JWT
          JWT_PAYLOAD=$(cat /opt/jwt_svid.token | cut -d'.' -f2)
          CLIENT_ID=$(echo "$JWT_PAYLOAD"== | base64 -d 2>/dev/null | python -c "import sys,json; print(json.load(sys.stdin).get('sub',''))")
          echo "$CLIENT_ID" > /shared/client-id.txt
          echo "Client ID (SPIFFE ID): $CLIENT_ID"

          echo "Starting client registration..."
          python client_registration.py
          echo "Client registration complete!"
          echo "Staying alive to keep pod running..."
          tail -f /dev/null
        env:
        - name: SPIRE_ENABLED
          valueFrom:
            configMapKeyRef:
              key: SPIRE_ENABLED
              name: authbridge-environments
        - name: KEYCLOAK_URL
          valueFrom:
            configMapKeyRef:
              key: KEYCLOAK_URL
              name: authbridge-environments
        - name: KEYCLOAK_REALM
          valueFrom:
            configMapKeyRef:
              key: KEYCLOAK_REALM
              name: authbridge-environments
        - name: KEYCLOAK_ADMIN_USERNAME
          valueFrom:
            configMapKeyRef:
              key: KEYCLOAK_ADMIN_USERNAME
              name: authbridge-environments
        - name: KEYCLOAK_ADMIN_PASSWORD
          valueFrom:
            configMapKeyRef:
              key: KEYCLOAK_ADMIN_PASSWORD
              name: authbridge-environments
        - name: KEYCLOAK_TOKEN_EXCHANGE_ENABLED
          valueFrom:
            configMapKeyRef:
              key: KEYCLOAK_TOKEN_EXCHANGE_ENABLED
              name: authbridge-environments
        - name: KEYCLOAK_CLIENT_REGISTRATION_ENABLED
          valueFrom:
            configMapKeyRef:
              key: KEYCLOAK_CLIENT_REGISTRATION_ENABLED
              name: authbridge-environments
        - name: CLIENT_NAME
          value: nps-agent
        - name: SECRET_FILE_PATH
          value: /shared/client-secret.txt
        volumeMounts:
        - name: shared-data
          mountPath: /shared
        - name: svid-output
          mountPath: /opt
        resources:
          requests:
            cpu: 25m
            memory: 32Mi
          limits:
            cpu: 100m
            memory: 128Mi
        securityContext:
          seLinuxOptions:
            type: spc_t
      # AuthBridge: Envoy Proxy — transparent token exchange
      - name: envoy-proxy
        image: ghcr.io/kagenti/kagenti-extensions/envoy-with-processor:latest
        imagePullPolicy: IfNotPresent
        env:
        - name: TOKEN_URL
          valueFrom:
            secretKeyRef:
              key: TOKEN_URL
              name: authbridge-proxy-config
        - name: ISSUER
          valueFrom:
            secretKeyRef:
              key: ISSUER
              name: authbridge-proxy-config
        - name: TARGET_AUDIENCE
          valueFrom:
            secretKeyRef:
              key: TARGET_AUDIENCE
              name: authbridge-proxy-config
        - name: TARGET_SCOPES
          valueFrom:
            secretKeyRef:
              key: TARGET_SCOPES
              name: authbridge-proxy-config
        - name: CLIENT_ID_FILE
          value: /shared/client-id.txt
        - name: CLIENT_SECRET_FILE
          value: /shared/client-secret.txt
        ports:
        - containerPort: 15123
          name: envoy-outbound
          protocol: TCP
        - containerPort: 15124
          name: envoy-inbound
          protocol: TCP
        - containerPort: 9901
          name: envoy-admin
          protocol: TCP
        - containerPort: 9090
          name: ext-proc
          protocol: TCP
        volumeMounts:
        - name: authbridge-envoy-config
          mountPath: /etc/envoy
          readOnly: true
        - name: shared-data
          mountPath: /shared
          readOnly: true
        resources:
          requests:
            cpu: 50m
            memory: 64Mi
          limits:
            cpu: 200m
            memory: 256Mi
        securityContext:
          runAsUser: 1337
          runAsGroup: 1337
          seLinuxOptions:
            type: spc_t
      volumes:
      # AuthBridge volumes
      - name: shared-data
        emptyDir: {}
      - name: svid-output
        emptyDir: {}
      - name: spire-agent-socket
        csi:
          driver: csi.spiffe.io
          readOnly: true
      - name: authbridge-spiffe-helper-config
        configMap:
          name: authbridge-spiffe-helper-config
      - name: authbridge-envoy-config
        configMap:
          name: authbridge-envoy-config
      # A2A bridge script
      - name: a2a-bridge-script
        configMap:
          name: nps-agent-a2a-bridge
      # Patched npsagent.py — uses ChatCompletions model to work with vLLM
      - name: npsagent-patch
        configMap:
          name: npsagent-patch
