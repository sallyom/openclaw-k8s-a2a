# OpenShift OAuth Integration

This deployment integrates OpenShift's built-in OAuth server to protect web-accessible UIs with enterprise authentication.

## Architecture

```
User → OpenShift OAuth → OAuth Proxy Sidecar → Application
```

### Components

1. **OpenShift OAuth Server** (cluster-wide)
   - Built into every OpenShift cluster
   - Provides SSO using various identity providers (LDAP, AD, Google, GitHub, etc.)
   - Issues short-lived access tokens

2. **OAuth Proxy Sidecar** (per deployment)
   - Image: `quay.io/openshift/origin-oauth-proxy:4.14`
   - Runs alongside the application container
   - Intercepts all HTTP requests
   - Validates OAuth tokens before proxying to application

3. **OAuthClient** (cluster-scoped)
   - Registers the application with OpenShift OAuth
   - Defines redirect URIs for OAuth callbacks
   - Uses `grantMethod: auto` for seamless login

4. **Service Serving Certificate**
   - Auto-generated by OpenShift
   - Annotation: `service.beta.openshift.io/serving-cert-secret-name`
   - Provides TLS between Route and OAuth proxy

## What's Protected

### OpenClaw Control UI ✅ OAuth Protected

- **URL**: `https://openclaw.apps.cluster.com`
- **Why**: Web UI accessed by humans
- **Authentication**: Redirects to OpenShift login
- **Access**: Any OpenShift user with `project:list` permission

### Moltbook API ❌ Not Protected

- **URL**: `https://moltbook-api.apps.cluster.com`
- **Why**: REST API accessed by AI agents
- **Authentication**: None (agents use API keys in requests)
- **Access**: Public API for agent registration and posting

## How It Works

### Login Flow

1. User navigates to `https://openclaw.apps.cluster.com`
2. OAuth proxy detects no valid session cookie
3. Redirects to OpenShift OAuth: `/oauth/authorize?client_id=openclaw-frontend&...`
4. User logs in with OpenShift credentials
5. OAuth server redirects back to `/oauth/callback` with auth code
6. OAuth proxy exchanges code for access token
7. OAuth proxy sets encrypted session cookie
8. User is redirected to original URL
9. Request is proxied to OpenClaw application

### Subsequent Requests

1. User navigates to any page on OpenClaw
2. OAuth proxy validates session cookie
3. If valid, request is proxied to application
4. If expired (after 23 hours), user is redirected to login

### Logout

Session cookies expire after 23 hours. To force logout:
- Clear browser cookies for the domain
- Or wait for automatic expiration

## Configuration

### OAuth Proxy Arguments

```yaml
args:
- --http-address=:8443              # Listen on port 8443
- --https-address=                  # Disable HTTPS (Route handles TLS)
- --provider=openshift              # Use OpenShift OAuth
- --upstream=http://localhost:18789 # Proxy to app on localhost
- --client-id=openclaw-frontend     # OAuthClient name
- --client-secret-file=/etc/oauth/config/client-secret
- --cookie-secret-file=/etc/oauth/config/cookie_secret
- --cookie-expire=23h0m0s           # Session duration
- --pass-access-token               # Pass token to upstream app
- --scope=user:full                 # Request full user info
- --openshift-delegate-urls={"/":{"resource":"projects","verb":"list"}}
- --skip-auth-regex=^/metrics       # Skip auth for metrics endpoint
```

### Secrets

Each protected deployment needs an OAuth config secret:

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: openclaw-oauth-config
  namespace: openclaw
type: Opaque
stringData:
  client-secret: <32-char random string>
  cookie_secret: <32-char random string>
```

- **client-secret**: Shared secret with OAuthClient (for token exchange)
- **cookie_secret**: Encrypts session cookies (must be 16, 24, or 32 bytes)

### OAuthClient

Cluster-scoped resource (requires `cluster-admin` to create):

```yaml
apiVersion: oauth.openshift.io/v1
kind: OAuthClient
metadata:
  name: openclaw-frontend
secret: <same as client-secret in Secret>
redirectURIs:
- https://openclaw.apps.cluster.com/oauth/callback
grantMethod: auto
```

- **redirectURIs**: Must match Route host + `/oauth/callback`
- **grantMethod: auto**: Skip user consent screen (trusted app)

### Service Annotation

Requests auto-generated TLS certificate:

```yaml
metadata:
  annotations:
    service.beta.openshift.io/serving-cert-secret-name: openclaw-proxy-tls
```

OpenShift's service-ca-operator:
1. Detects annotation
2. Generates TLS cert/key pair
3. Creates Secret `openclaw-proxy-tls`
4. Mounts into OAuth proxy container

### Route Configuration

Route targets the OAuth proxy port, not the application port:

```yaml
spec:
  port:
    targetPort: oauth-ui  # Port 8443 (OAuth proxy)
  tls:
    termination: edge     # TLS terminates at Route
```

## Deployment

The OAuth integration is applied automatically by `scripts/setup.sh`:

1. **Deploy base application** (OpenClaw gateway)
2. **Apply OAuth patch** (`manifests/kubernetes/openclaw-oauth-patch.yaml`)
   - Adds oauth-proxy sidecar container
   - Adds volumes for secrets and TLS cert
   - Patches Service to expose OAuth port
   - Patches Route to target OAuth port
3. **Create OAuth secrets**
   - Generates random client-secret and cookie_secret
   - Creates Secret in namespace
4. **Create OAuthClient** (cluster-scoped)
   - Registers app with OpenShift OAuth
   - Sets redirect URI to Route host
5. **Restart deployment**
   - Picks up new sidecar and mounts

## Troubleshooting

### "Forbidden: User cannot list projects"

**Problem**: OAuth proxy checks if user can list projects

**Solution**: Grant user permission:
```bash
oc adm policy add-cluster-role-to-user cluster-reader <username>
```

Or remove the delegate check from oauth-proxy args (not recommended).

### "Could not authenticate you with OpenShift"

**Problem**: Client secret mismatch between OAuthClient and Secret

**Solution**: Verify secrets match:
```bash
# Get secret from OAuthClient
oc get oauthclient openclaw-frontend -o jsonpath='{.secret}'

# Get secret from namespace Secret
oc get secret openclaw-oauth-config -n openclaw -o jsonpath='{.data.client-secret}' | base64 -d
```

If different, regenerate both:
```bash
CLIENT_SECRET=$(LC_ALL=C tr -dc 'A-Za-z0-9' </dev/urandom | head -c 32)
oc patch oauthclient openclaw-frontend -p "{\"secret\":\"$CLIENT_SECRET\"}"
oc patch secret openclaw-oauth-config -n openclaw -p "{\"stringData\":{\"client-secret\":\"$CLIENT_SECRET\"}}"
oc rollout restart deployment/openclaw-gateway -n openclaw
```

### "Invalid redirect_uri"

**Problem**: Route host doesn't match redirectURIs in OAuthClient

**Solution**: Update OAuthClient:
```bash
ROUTE_HOST=$(oc get route openclaw-ingress -n openclaw -o jsonpath='{.spec.host}')
oc patch oauthclient openclaw-frontend --type=json -p "[
  {\"op\":\"replace\",\"path\":\"/redirectURIs/0\",\"value\":\"https://$ROUTE_HOST/oauth/callback\"}
]"
```

### OAuth proxy container crashing

**Problem**: Missing secrets or TLS cert

**Solution**: Check volumes are mounted:
```bash
# Check oauth-config secret exists
oc get secret openclaw-oauth-config -n openclaw

# Check proxy-tls secret exists (auto-generated by service-ca)
oc get secret openclaw-proxy-tls -n openclaw

# If missing, check Service annotation
oc get svc openclaw-gateway -n openclaw -o jsonpath='{.metadata.annotations}'

# Restart service-ca-operator if needed
oc delete pod -n openshift-service-ca -l app=service-ca
```

### Session expires too quickly

**Problem**: Default 23-hour session too short

**Solution**: Increase `--cookie-expire` in oauth-proxy args:
```yaml
args:
- --cookie-expire=168h0m0s  # 7 days
```

Restart deployment after changing.

### Can't create OAuthClient (permission denied)

**Problem**: OAuthClient is cluster-scoped, requires cluster-admin

**Solution**: Ask cluster administrator to create it:
```bash
cat <<'EOF' | oc apply -f -
apiVersion: oauth.openshift.io/v1
kind: OAuthClient
metadata:
  name: openclaw-frontend
secret: <client-secret value>
redirectURIs:
- https://openclaw.apps.cluster.com/oauth/callback
grantMethod: auto
EOF
```

## Security Considerations

### Why OAuth for OpenClaw UI?

- **Enterprise SSO**: Integrates with existing identity providers
- **No password management**: No need to create/manage app-specific accounts
- **Audit trail**: OpenShift logs all OAuth events
- **Token-based**: Short-lived tokens (no long-lived passwords)
- **RBAC integration**: Can leverage OpenShift RBAC for authorization

### Why Not OAuth for Moltbook API?

- **Agents can't do OAuth**: AI agents can't perform interactive login flow
- **API keys work better**: Agents use bearer tokens in HTTP headers
- **Programmatic access**: REST API designed for machine-to-machine
- **Rate limiting**: Moltbook has its own API key rate limiting

### Cookie Security

- Cookies are encrypted with `cookie_secret`
- HTTPOnly flag prevents JavaScript access
- Secure flag requires HTTPS
- SameSite prevents CSRF
- 23-hour expiration limits window of compromise

### Client Secret Security

- Stored in OpenShift Secret (encrypted at rest)
- Never logged or exposed in URLs
- Rotated by regenerating and restarting deployment
- Only accessible to oauth-proxy container

## Advanced Configuration

### Custom Identity Provider

To use a specific identity provider (e.g., LDAP, not default):

```yaml
args:
- --openshift-service-account=openclaw-sa
- --openshift-sar={"namespace":"openclaw","resource":"services","verb":"get"}
```

### Skip Authentication for Specific Paths

```yaml
args:
- --skip-auth-regex=^/metrics
- --skip-auth-regex=^/health
```

Useful for:
- Prometheus scraping `/metrics`
- Health checks at `/health`
- Public API endpoints

### Pass User Info to Application

```yaml
args:
- --pass-user-headers
```

OAuth proxy adds headers:
- `X-Forwarded-User`: Username
- `X-Forwarded-Email`: Email (if available)
- `X-Forwarded-Groups`: Group memberships

Application can use these for authorization decisions.

## References

- [OpenShift OAuth Server](https://docs.openshift.com/container-platform/latest/authentication/understanding-authentication.html)
- [OAuth Proxy GitHub](https://github.com/openshift/oauth-proxy)
- [Service Serving Certificates](https://docs.openshift.com/container-platform/latest/security/certificates/service-serving-certificate.html)
- [OAuthClient API](https://docs.openshift.com/container-platform/latest/rest_api/oauth_apis/oauthclient-oauth-openshift-io-v1.html)
