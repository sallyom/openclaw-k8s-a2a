---
# ConfigMap patch to add agents to the OpenClaw config
# Apply this AFTER running agent-setup-job.yaml to register the agents
#
# Usage:
#   oc apply -f agents-config-patch.yaml
#   oc delete pod -n openclaw -l app=openclaw  # Restart to pick up config
#
# OpenTelemetry trace export options:
#   Option 1 (recommended): Via OTEL collector sidecar for batching/routing
#     diagnostics.otel.endpoint: "http://localhost:4318"
#   Option 2: Direct to MLflow (bypasses collector)
#     diagnostics.otel.endpoint: "http://mlflow-service.mlflow.svc.cluster.local:5000"
apiVersion: v1
kind: ConfigMap
metadata:
  name: openclaw-config
  namespace: ${OPENCLAW_NAMESPACE}
data:
  openclaw.json: |
    {
      "plugins": {
        "allow": ["diagnostics-otel"],
        "entries": {
          "diagnostics-otel": {
            "enabled": true
          }
        }
      },
      "gateway": {
        "mode": "local",
        "bind": "loopback",
        "port": 18789,
        "trustedProxies": ["10.128.0.0/14"],
        "auth": {
          "mode": "token",
          "allowTailscale": false
        },
        "controlUi": {
          "enabled": true,
          "dangerouslyDisableDeviceAuth": true,
          "allowedOrigins": ["https://openclaw-${OPENCLAW_NAMESPACE}.${CLUSTER_DOMAIN}"]
        },
        "http": {
          "endpoints": {
            "chatCompletions": {"enabled": true}
          }
        }
      },
      "diagnostics": {
        "enabled": true,
        "otel": {
          "enabled": true,
          "endpoint": "http://localhost:4318",
          "traces": true,
          "metrics": true,
          "logs": false
        }
      },
      "models": {
        "providers": {
          "nerc": {
            "baseUrl": "${MODEL_ENDPOINT}",
            "api": "openai-completions",
            "apiKey": "fakekey",
            "models": [
              {
                "id": "openai/gpt-oss-20b",
                "name": "GPT OSS 20B",
                "reasoning": false,
                "input": ["text"],
                "cost": {
                  "input": 0,
                  "output": 0,
                  "cacheRead": 0,
                  "cacheWrite": 0
                },
                "contextWindow": 32768,
                "maxTokens": 8192
              }
            ]
          },
          "anthropic": {
            "baseUrl": "https://api.anthropic.com",
            "api": "anthropic-messages",
            "apiKey": "${ANTHROPIC_API_KEY}",
            "models": [
              {
                "id": "claude-sonnet-4-5-20250929",
                "name": "Claude Sonnet 4.5",
                "reasoning": true,
                "input": ["text", "image"],
                "contextWindow": 200000,
                "maxTokens": 64000
              }
            ]
          }
        }
      },
      "skills": {
        "load": {
          "extraDirs": ["~/.openclaw/skills"],
          "watch": true,
          "watchDebounceMs": 1000
        }
      },
      "tools": {
        "allow": [
          "read",
          "write",
          "edit",
          "exec",
          "web_search",
          "sessions_list",
          "sessions_history",
          "sessions_send",
          "sessions_spawn",
          "session_status",
          "message",
          "agents_list",
          "cron"
        ],
        "deny": [
          "browser",
          "canvas",
          "nodes",
          "process",
          "tts",
          "web_fetch",
          "gateway"
        ],
        "exec": {
          "security": "allowlist",
          "safeBins": ["cat", "curl", "jq"],
          "safeBinProfiles": {
            "cat": {},
            "curl": {"deniedFlags": ["-o", "--output", "-O", "--remote-name", "--upload-file", "-T"]},
            "jq": {"maxPositional": 1, "allowedValueFlags": ["--arg", "--argjson", "--argstr"], "deniedFlags": ["--argfile", "--rawfile", "--slurpfile", "--from-file", "--library-path", "-L", "-f"]}
          },
          "timeoutSec": 30
        },
        "agentToAgent": {
          "enabled": true,
          "allow": ["*"]
        }
      },
      "agents": {
        "defaults": {
          "workspace": "~/.openclaw/workspace",
          "model": {
            "primary": "nerc/openai/gpt-oss-20b"
          }
        },
        "list": [
          {
            "id": "${OPENCLAW_PREFIX}_${SHADOWMAN_CUSTOM_NAME}",
            "name": "${SHADOWMAN_DISPLAY_NAME}",
            "workspace": "~/.openclaw/workspace-${OPENCLAW_PREFIX}_${SHADOWMAN_CUSTOM_NAME}",
            "model": {"primary": "${DEFAULT_AGENT_MODEL}"},
            "subagents": {"allowAgents": ["*"]}
          },
          {
            "id": "${OPENCLAW_PREFIX}_resource_optimizer",
            "name": "${OPENCLAW_PREFIX}'s Resource Optimizer - Cost Analysis",
            "workspace": "~/.openclaw/workspace-${OPENCLAW_PREFIX}_resource_optimizer",
            "subagents": {"allowAgents": ["*"]}
          },
          {
            "id": "${OPENCLAW_PREFIX}_mlops_monitor",
            "name": "${OPENCLAW_PREFIX}'s MLOps Monitor",
            "workspace": "~/.openclaw/workspace-${OPENCLAW_PREFIX}_mlops_monitor",
            "subagents": {"allowAgents": ["*"]}
          }
        ]
      },
      "skills": {
        "load": {
          "extraDirs": ["~/.openclaw/skills"],
          "watch": true,
          "watchDebounceMs": 1000
        }
      },
      "session": {
        "store": "~/.openclaw/agents/{agentId}/sessions/sessions.json"
      },
      "cron": {
        "enabled": true
      }
    }
